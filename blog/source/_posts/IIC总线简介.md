---
title: IIC总线简介
date: 2017-10-14 21:58:15
tags:
---


## **1. 背景**
- I2C总线是由Philips公司开发的一种简单、双向二线制同步串行总线。
- 它只需要两根线即可在连接于总线上的器件之间传送信息。

## **2. 基本原理**

#### **a. 总线组成：**

-  **两根线**：SDA（串行数据线）和SCL（串行时钟线），它们都是双向I/O线，接口电路为开漏输出．
<!-- more -->
#### **b. 电路特征**

- 需通过上拉电阻接电源VCC．当总线空闲时．两根线都是高电平，连接总线的外部器件都是CMOS器件，输出级也是开漏电路．
- 在总线上消耗的电流很小，因此，总线上扩展的器件数量主要由电容负载来决定，因为每个器件的总线接口都有一定的等效电容． 
- 线路中电容会影响总线传输速度．当电容过大时，有可能造成传输错误．所以，其负载能力为400pF，因此可以估算出总线允许长度和所接器件数量。

#### **c. 主从概念：**

- 主器件用于启动总线传送数据，并产生时钟以开放传送的器件，任何被寻址的器件均被认为是从器件。
- 总线上任意设备可成为主设备，同一时刻只能有一个主设备。
- 在总线上**主和从**、**发和收**的关系**不是恒定**的，而是取决于此时数据传送方向。

#### **d. 发送数据：**

- 主机首先寻址从器件，然后主动发送数据至从器件，最后由主机终止数据传送； 

#### **e.  接收数据：**

- 首先由主器件寻址从器件．然后主机接收从器件发送的数据，最后由主机终止接收过程。在这种情况下．主机负责产生定时时钟和终止数据传送。

## **3. 优点**

- 在硬件上，12C总线只需要一根数据线和一根时钟线两根线。

- 每个连接到总线上的器件都有唯一的地址，任何器件既可以作为主机也可以作为从机，但同一时刻只允许有一个主机。

- 数据传输和地址设定由软件设定，非常灵活。总线上的器件增加和删除不影响其他器件正常工作。

- I2C总线可以通过外部连线进行在线检测，便于系统故障诊断和调试，故障可以立即被寻址，软件也利于标准化和模块化，缩短开发时问。

- 连接到相同总线上的IC数量只受总线最大电容的限制，串行的8位双向数据传输位速率在标准模式下可达100Kbit/s，快速模式下可达400Kbit/s，高速模式下可达3．4Mbit/s。

- 总线具有极低的电流消耗．抗高噪声干扰，增加总线驱动器可以使总线电容扩大10倍，传输距离达到15m；兼容不同电压等级的器件，工作温度范围宽。

## **4. 数据传输**

#### **a. 时序图**

![这里写图片描述](http://img.blog.csdn.net/20170929110309539?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMzA1MjY1NA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

**开始条件：** SCL 高， SDL产生一个下降沿，则视为开始。
**结束条件：** SCL 高， SDL产生一个上升沿，则视为结束。
因此，传输数据时，SCL拉低后，SDA改变数据，SCL拉高后，读取SDA上的数据。


#### **b. 字节格式**
- 发送到SDA 线上的每个字节**必须为8 位**，每次传输可以发送的字节数量不受限制。

- 每个字节后必须跟一个响应位。首先传输的是数据的最高位（MSB），**如果从机要完成一些其他功能后（例如一个内部中断服务程序）才能接收或发送下一个完整的数据字节，可以使时钟线SCL 保持低电平，迫使主机进入等待状态，当从机准备好接收下一个数据字节并释放时钟线SCL 后数据传输继续。**

#### **c. 应答响应**

- 数据传输必须带响应，相关的响应时钟脉冲由主机产生。在响应的时钟脉冲期间发送器释放SDA 线（高）。

- 在响应的时钟脉冲期间，接收器必须将SDA 线拉低，使它在这个时钟脉冲的高电平期间保持稳定的低电平。

- 通常被寻址的接收器在接收到的每个字节后，除了用CBUS 地址开头的数据，必须产生一个响应。

- 当从机不能响应从机地址时（例如它正在执行一些实时函数不能接收或发送），从机必须使数据线保持高电平，主机然后产生一个停止条件终止传输或者产生重复起始条件开始新的传输。这个情况用从机在第一个字节后没有产生响应来表示。从机使数据线保持高电平，主机产生一个停止或重复起始条件。

- 如果传输中有主机接收器，它必须通过在从机发出的最后一个字节时产生一个响应，向从机发送器通知数据结束。从机发送器必须释放数据线，允许主机产生一个停止或重复起始条件。

#### **d. 时钟同步**

- 所有主机在SCL线上产生它们自己的时钟来传输I2C总线上的报文。数据只在时钟的高电平周期有效，因此需要一个确定的时钟进行逐位仲裁。

- 时钟同步通过线与连接I2C 接口到SCL 线来执行。这就是说SCL 线的高到低切换会使器件开始数它们的低电平周期，而且一旦器件的时钟变低电平，它会使SCL 线保持这种状态直到到达时钟的高电平。

- 但是如果另一个时钟仍处于低电平周期，这个时钟的低到高切换不会改变SCL 线的状态。因此SCL 线被有最长低电平周期的器件保持低电平。此时低电平周期短的器件会进入高电平的等待状态。

- 当所有有关的器件数完了它们的低电平周期后，时钟线被释放并变成高电平。之后，器件时钟和SCL线的状态没有差别，而且所有器件会开始数它们的高电平周期。首先完成高电平周期的器件会再次将SCL线拉低。

- 这样产生的同步SCL 时钟的**低电平周期由低电平时钟周期最长的器件决定**，而**高电平周期由高电平时钟周期最短的器件决定**。


## **5. 通信模式**

### **a. 快速模式**
**快速模式器件可以在400kbit/s 下接收和发送。最小要求是：**

- 它们可以和400kbit/s 传输同步，可以延长SCL 信号的低电平周期来减慢传输。

- **快速模式器件都向下兼容**，可以和标准模式器件在0~100kbit/s 的I2C 总线系统通讯。

- 但是，由于**标准模式器件不向上兼容**，所以不能在快速模式I2C 总线系统中工作。

**快速模式I2C 总线规范与标准模式相比有以下特征：**

- 最大位速率增加到400kbit/s；

- 调整了串行数据（SDA） 和串行时钟（SCL ）信号的时序；

- 快速模式器件的输入有抑制毛刺的功能，SDA 和SCL输入有施密特触发器；

- 快速模式器件的输出缓冲器对SDA 和SCL 信号的下降沿有斜率控制功能；

- 如果快速模式器件的**电源电压被关断**，**SDA 和SCL 的I/O 管脚必须悬空，不能阻塞总线**；

- 连接到总线的外部上拉器件必须调整以适应快速模式I2C 总线更短的最大允许上升时间。对于负载最大是200pF 的总线，每条总线的上拉器件可以是一个电阻，对于负载在200pF~400pF 之间的总线，上拉器件可以是一个电流源（最大值3mA ）或者是一个开关电阻电路。

### **b. 高速模式**

- 高速模式（Hs 模式）器件对I2C 总线的传输速度有巨大的突破。

- Hs 模式器件可以在高达3.4Mbit/s 的位速率下传输信息，而且**保持完全向下兼容快速模式或标准模式**（F/S 模式）器件，它们可以在一个速度混合的总线系统中双向通讯。

- Hs 模式传输除了**不执行仲裁和时钟同步外**，与F/S 模式系统有相同的串行总线协议和数据格式。

**高速模式下I2C 总线规范如下：**

- Hs 模式主机器件有一个SDAH 信号的开漏输出缓冲器和一个在SCLH 输出的开漏极下拉和电流源上拉电路。这个电流源电路**缩短了SCLH 信号的上升时间**，任何时候在Hs 模式，只有一个主机的电流源有效；

- 在多主机系统的Hs 模式中，不执行仲裁和时钟同步，以加速位处理能力。仲裁过程一般在前面用F/S 模式传输主机码后结束；

- Hs 模式主机器件以高电平和低电平是1:2 的比率产生一个串行时钟信号。解除了建立和保持时间的时序要求；

-  可以选择Hs 模式器件有内建的电桥。在Hs 模式传输中，Hs 模式器件的高速数据（SDAH）和高速串行时钟（SCLH ）线通过这个电桥与F/S 模式器件的SDA 和SCL 线分隔开来。减轻了SDAH 和SCLH 线的电容负载，使上升和下降时间更快；

- Hs 模式从机器件与F/S 从机器件的唯一差别是它们工作的速度。Hs 模式从机在SCLH 和SDAH输出有开漏输出的缓冲器。SCLH 管脚可选的下拉晶体管可以用于拉长SCLH 信号的低电平，但只允许在Hs 模式传输的响应位后进行；

-  Hs 模式器件的输出可以抑制毛刺，而且SDAH 和SCLH 输出有一个施密特触发器；

- Hs 模式器件的输出缓冲器对SDAH 和SCLH 信号的下降沿有斜率控制功能。
